# Capital Gains ‚Äì Code Challenge (JavaScript/Node.js)

Este reposit√≥rio implementa o desafio de **c√°lculo de imposto sobre ganho de capital** com entrada via **stdin** e sa√≠da via **stdout**, seguindo as regras e o formato descritos no enunciado.

## üöÄ Novas Funcionalidades

### Vers√£o Atual
- ‚úÖ **Valida√ß√£o de Estoque**: Sistema valida automaticamente se h√° a√ß√µes suficientes antes de permitir uma venda
- ‚úÖ **Bloqueio de Conta**: Ap√≥s 3 erros consecutivos de estoque insuficiente, a conta √© bloqueada para prevenir opera√ß√µes futuras
- ‚úÖ **Tratamento de Erros Robusto**: Classes de erro customizadas com mensagens claras e rastreabilidade
- ‚úÖ **Novos Testes**: Adicionados testes E2E e unit√°rios para valida√ß√£o de erros e cen√°rios de bloqueio
- ‚úÖ **Modo Watch para Desenvolvimento**: Execute testes em modo watch para desenvolvimento cont√≠nuo

---

## ‚ú® Contexto do Desafio

- A aplica√ß√£o l√™ **uma ou mais listas JSON por linha** a partir de `stdin`. Cada **lista** representa **uma simula√ß√£o independente**.
- Para cada opera√ß√£o na lista, deve-se imprimir **na sa√≠da padr√£o** uma **lista JSON** de mesmo tamanho contendo objetos `{ "tax": number }` ou `{ "error": string }` em caso de erro.
- O programa **encerra** ao receber **uma linha vazia** (quando em modo interativo) ou no **EOF** (quando usando pipe/arquivo).

### Regras de Neg√≥cio (resumo)
- **Compras (`buy`)**: n√£o h√° imposto e **atualizam o pre√ßo m√©dio ponderado** da carteira.
- **Vendas (`sell`)**: podem gerar imposto.
  - Calcular **lucro bruto**: `(pre√ßo de venda - pre√ßo m√©dio) √ó quantidade vendida`.
  - **Preju√≠zos**: se o lucro bruto for **‚â§ 0**, **n√£o h√° imposto** e o preju√≠zo √© **acumulado** para compensa√ß√µes futuras.
  - **Isen√ß√£o por opera√ß√£o**: se o **valor total da venda** (pre√ßo √ó quantidade) for **‚â§ 20.000,00**, **n√£o h√° imposto**, e **lucros** nesse caso **n√£o consomem** o preju√≠zo acumulado.
  - **Opera√ß√£o tribut√°vel** (> 20.000,00): o **preju√≠zo acumulado** √© **consumido** para reduzir o lucro, e o que sobrar √© tributado a **20%**.
- **Pre√ßo m√©dio ponderado** s√≥ muda em **compras**; **vendas** n√£o alteram a m√©dia.
- **Valida√ß√£o de estoque**: Vendas acima do estoque dispon√≠vel geram erro com a mensagem "Can't sell more stocks than you have".
- **Bloqueio de conta**: Ap√≥s 3 erros consecutivos de estoque insuficiente, a conta √© bloqueada e opera√ß√µes subsequentes retornam "Your account is blocked".

### Formato num√©rico
- Todos os c√°lculos internos s√£o feitos em **centavos (inteiros)** para evitar erros de ponto flutuante.
- A sa√≠da imprime `number` com **duas casas decimais** quando necess√°rio (JSON permite remover zeros √† direita).

---

## ‚ñ∂Ô∏è Como Rodar

### Pr√©-requisitos

#### Para execu√ß√£o local:
- **Node.js 18+** (funciona tamb√©m em 20/22)

#### Para execu√ß√£o com Docker:
- **Docker** e **Docker Compose** instalados
- **Nenhuma instala√ß√£o de Node.js necess√°ria!**

#### **Utilizando Docker**
Para rodar o projeto com docker, √© necess√°rio ter ele instalado na sua m√°quina, caso n√£o tenha, siga as instru√ß√µes dos links:
- **Ubuntu:** [Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/)
- **Mac:** [Install Docker Engine on Mac](https://docs.docker.com/desktop/install/mac-install/)
- **Windows:** [Install Docker Engine on Windows](https://docs.docker.com/desktop/install/windows-install/)

Comece buildando e subindo seu container:
```
docker compose up -d --build
```

Se a sua vers√£o do docker-compose for mais antiga, use:
```
docker-compose up -d --build
```

### Instala√ß√£o

#### Op√ß√£o 1: Com Node.js Local
```bash
npm i
```

#### Op√ß√£o 2: Com Docker (Sem instala√ß√£o do Node.js)
Apenas certifique-se de ter Docker instalado. **Nenhuma instala√ß√£o de Node.js necess√°ria!**

### Execu√ß√£o (CLI)

#### Com Node.js Local
Rode a aplica√ß√£o e forne√ßa uma linha com uma **lista JSON** de opera√ß√µes (`buy`/`sell`):

```bash
npm start
# cole uma linha JSON e tecle Enter
# tecle Enter novamente numa linha vazia para encerrar
```

#### Com Docker
**Modo Interativo**:
```bash
docker-compose run --rm code-challenge
# cole uma linha JSON e tecle Enter
# tecle Enter novamente numa linha vazia para encerrar
```

**Ou construa e execute diretamente**:
```bash
docker build -t code-challenge .
docker run -it --rm code-challenge
```

#### Exemplos r√°pidos

##### Com Node.js Local:
- **Com pipe** (campos oficiais `unit-cost`):
```bash
echo '[{"operation":"buy","unit-cost":10.00,"quantity":100},{"operation":"sell","unit-cost":12.00,"quantity":50}]' | npm start
```
- **Aceita tamb√©m `unitCost`**:
```bash
echo '[{"operation":"buy","unitCost":10,"quantity":100},{"operation":"sell","unitCost":12,"quantity":50}]' | npm start
```
- **Lendo de arquivo**:
```bash
npm start < input.txt
```

##### Com Docker:
- **Com pipe**:
```bash
echo '[{"operation":"buy","unit-cost":10.00,"quantity":100},{"operation":"sell","unit-cost":12.00,"quantity":50}]' | docker-compose run --rm code-challenge
```
- **Lendo de arquivo**:
```bash
docker-compose run --rm code-challenge < input.txt
```

> **Nota**: Onde `input.txt` cont√©m uma ou mais linhas, cada uma com uma lista JSON de opera√ß√µes.

#### V√°rias simula√ß√µes na mesma linha
- **Arrays colados** (funciona em ambas as vers√µes):
```bash
echo '[{"operation":"buy","unit-cost":10,"quantity":100}][{"operation":"sell","unit-cost":15,"quantity":100}]' | npm start
# ou com Docker:
echo '[{"operation":"buy","unit-cost":10,"quantity":100}][{"operation":"sell","unit-cost":15,"quantity":100}]' | docker-compose run --rm code-challenge
# o programa emitir√° DUAS linhas de sa√≠da (uma por lista)
```

---

## ‚úÖ Regras & Crit√©rios de Aceite

1. **Entrada/sa√≠da**
   - L√™ de **stdin** e imprime **apenas** listas JSON v√°lidas em **stdout**, **uma por lista** de entrada.
   - **Uma simula√ß√£o por lista**: o estado **n√£o se carrega** entre listas de **linhas diferentes** (ou arrays colados).
   - Encerramento por **linha vazia** (interativo) ou **EOF** (pipe/arquivo).
   - Retorna objetos de erro `{ "error": string }` para opera√ß√µes inv√°lidas.

2. **C√°lculo de imposto**
   - **20%** sobre o **lucro tribut√°vel** de **vendas**.
   - **Pre√ßo m√©dio** atualizado **apenas** em **compras** (m√©dia ponderada, arredondada para centavos).
   - **Preju√≠zo acumulado**: sempre acumula quando a venda gera preju√≠zo; √© **consumido** somente em **opera√ß√µes tribut√°veis** (> 20k).
   - **Isen√ß√£o por opera√ß√£o ‚â§ 20.000,00**: n√£o h√° imposto; **lucros isentos n√£o consomem** preju√≠zo; **preju√≠zos isentos** continuam acumulando.

3. **Valida√ß√£o e tratamento de erros**
   - **Estoque insuficiente**: Valida que n√£o √© poss√≠vel vender mais a√ß√µes do que se possui.
   - **Bloqueio de conta**: Ap√≥s 3 erros consecutivos de estoque insuficiente, bloqueia novas opera√ß√µes.
   - **Tratamento de erros**: Sistema robusto de tratamento de erros com mensagens claras.

4. **Formata√ß√£o e precis√£o**
   - C√°lculos internos em **centavos**; sa√≠da num√©rica compat√≠vel com JSON.
   - Arredondamento de m√©dia e imposto para **2 casas decimais**.

5. **Qualidade e testes**
   - **Testes unit√°rios** e **E2E** com **Jest**.
   - **Testes de valida√ß√£o de erros** incluindo cen√°rios de estoque insuficiente e bloqueio de conta.
   - Relat√≥rio de **coverage** dispon√≠vel.

> **Aceite**: O desafio √© considerado pronto quando os **casos de teste E2E** (baseados no enunciado) passam, e os **testes unit√°rios** de dom√≠nio cobrem as regras-chave com cobertura adequada.

---

## üß™ Testes

### Com Node.js Local

#### Rodar todos os testes (unit + e2e)
```bash
npm test
```

#### Apenas unit√°rios
```bash
npm run test:unit
```

#### Apenas E2E (simulando o CLI)
```bash
npm run test:e2e
```

#### Testes em modo watch (desenvolvimento)
```bash
npm run test:watch
```

#### Coverage
```bash
npm run test:coverage
# relat√≥rio em texto + lcov (para CI/Codecov)
```

### Com Docker

#### Rodar todos os testes
```bash
docker-compose --profile test run --rm code-challenge-test
```

#### Ou construa e execute diretamente
```bash
docker build -f Dockerfile.test -t code-challenge-test .
docker run --rm code-challenge-test npm test
```

#### Para coverage com Docker
```bash
docker run --rm code-challenge-test npm run test:coverage
```

### Testes Dispon√≠veis

Os testes incluem:
- **Testes E2E**: Validam o comportamento completo do CLI com casos do enunciado
- **Testes de valida√ß√£o de erros**: Cen√°rios de estoque insuficiente e bloqueio de conta
- **Testes unit√°rios**: Cobrem dom√≠nio, pol√≠ticas fiscais, estado do portf√≥lio e c√°lculos monet√°rios
- **Testes de integra√ß√£o**: Validam a intera√ß√£o entre componentes

Novos testes adicionados:
- `cli.errors.e2e.test.js`: Testa valida√ß√£o de estoque e limite de erros consecutivos
- `insufficient.test.js`: Testes unit√°rios para cen√°rios de estoque insuficiente

---

## üèóÔ∏è Arquitetura & Estrutura

A solu√ß√£o segue um **Mon√≥lito Modular** com **Arquitetura Hexagonal (Ports & Adapters)**:

- **domain/** (puro): regras de neg√≥cio e c√°lculos, sem depend√™ncias de infra
  - `money.js` ‚Äî helpers monet√°rios (centavos/inteiros, arredondamento, m√©dia ponderada)
  - `portfolio/PortfolioState.js` ‚Äî estado (quantidade, pre√ßo m√©dio, preju√≠zo) com valida√ß√£o de estoque
  - `tax/TaxCalculator.js` ‚Äî orquestra a pol√≠tica de imposto
  - `tax/policies/BrazilEquities20pct.js` ‚Äî regra atual (isen√ß√£o ‚â§ 20k, 20%, consumo de preju√≠zo)
  - `operations.js` ‚Äî parser/valida√ß√£o de opera√ß√µes de entrada
  - `errors.js` ‚Äî classes de erro customizadas (DomainError, InsufficientStockError)
- **application/**: caso de uso que orquestra dom√≠nio e portas
  - `process-line.usecase.js` ‚Äî l√™ linhas, processa listas, escreve sa√≠da, gerencia erros e bloqueio de conta
- **ports/**: contratos para entrada/sa√≠da/log (`LineReaderPort`, `LineWriterPort`, `LoggerPort`)
- **adapters/**: implementa√ß√µes concretas de portas
  - `adapters/cli/StdinLineReader.js` ‚Äî leitura via `readline`
  - `adapters/cli/StdoutLineWriter.js` ‚Äî escrita `JSON.stringify`
  - `adapters/logging/ConsoleLogger.js` ‚Äî logging b√°sico
- **index/app**: bootstrap/wire-up

### Regras de depend√™ncia
- `domain` **n√£o** depende de `application`/`adapters`.
- `application` depende de `domain` e dos contratos em `ports`.
- `adapters` implementam `ports` e s√£o injetados no `app.js`.

### Por que √© bom para escalar/manter
- Trocar CLI por **HTTP/filas**: adiciona-se novos adapters, **sem** tocar no dom√≠nio.
- Mudar a regra fiscal (outro pa√≠s, taxa, limites): nova **Policy** plug√°vel.
- F√°cil de testar: dom√≠nio puro com unit, camada de aplica√ß√£o com dubl√™s, E2E via CLI.

### Decis√µes-chave
- **Centavos/inteiros** para precis√£o financeira.
- **Arredondamento** somente onde necess√°rio (m√©dia, imposto).
- **Sem** depend√™ncia externa em runtime; apenas **Jest** em dev/test.

---

## üìÅ Estrutura de Pastas (resumo)

```
code-challenge/
‚îú‚îÄ package.json
‚îú‚îÄ jest.config.js
‚îú‚îÄ Dockerfile
‚îú‚îÄ Dockerfile.test
‚îú‚îÄ docker-compose.yml
‚îú‚îÄ src/
‚îÇ  ‚îú‚îÄ index.js
‚îÇ  ‚îú‚îÄ app.js
‚îÇ  ‚îú‚îÄ application/
‚îÇ  ‚îÇ  ‚îî‚îÄ process-line.usecase.js
‚îÇ  ‚îú‚îÄ domain/
‚îÇ  ‚îÇ  ‚îú‚îÄ money.js
‚îÇ  ‚îÇ  ‚îú‚îÄ operations.js
‚îÇ  ‚îÇ  ‚îú‚îÄ errors.js
‚îÇ  ‚îÇ  ‚îú‚îÄ portfolio/
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ portfolio-state.js
‚îÇ  ‚îÇ  ‚îî‚îÄ tax/
‚îÇ  ‚îÇ     ‚îú‚îÄ tax-calculator.js
‚îÇ  ‚îÇ     ‚îî‚îÄ policies/
‚îÇ  ‚îÇ        ‚îî‚îÄ brazil-equities.js
‚îÇ  ‚îú‚îÄ ports/
‚îÇ  ‚îÇ  ‚îú‚îÄ line-reader.js
‚îÇ  ‚îÇ  ‚îú‚îÄ line-writer.js
‚îÇ  ‚îÇ  ‚îî‚îÄ logger.js
‚îÇ  ‚îî‚îÄ adapters/
‚îÇ     ‚îú‚îÄ cli/
‚îÇ     ‚îÇ  ‚îú‚îÄ stdin-line-reader.js
‚îÇ     ‚îÇ  ‚îî‚îÄ stdout-line-writer.js
‚îÇ     ‚îî‚îÄ logging/
‚îÇ        ‚îî‚îÄ console-logger.js
‚îî‚îÄ __tests__/
   ‚îú‚îÄ unit/
   ‚îÇ  ‚îú‚îÄ money.test.js
   ‚îÇ  ‚îú‚îÄ policy.test.js
   ‚îÇ  ‚îú‚îÄ portfolio.test.js
   ‚îÇ  ‚îî‚îÄ insufficient.test.js
   ‚îî‚îÄ e2e/
      ‚îú‚îÄ cli.e2e.test.js
      ‚îî‚îÄ cli.errors.e2e.test.js
```

---

## üîß Scripts
```json
{
  "start": "node ./src/index.js",
  "test": "node --experimental-vm-modules ./node_modules/jest/bin/jest.js --runInBand",
  "test:watch": "node --experimental-vm-modules ./node_modules/jest/bin/jest.js --watch",
  "test:unit": "node --experimental-vm-modules ./node_modules/jest/bin/jest.js __tests__/unit --runInBand",
  "test:e2e": "node --experimental-vm-modules ./node_modules/jest/bin/jest.js __tests__/e2e --runInBand",
  "test:coverage": "node --experimental-vm-modules ./node_modules/jest/bin/jest.js --runInBand --coverage",
  "test:coverage:e2e": "node --experimental-vm-modules ./node_modules/jest/bin/jest.js __tests__/e2e --runInBand --coverage",
  "test:coverage:unit": "node --experimental-vm-modules ./node_modules/jest/bin/jest.js __tests__/unit --runInBand --coverage",
  "lint": "eslint .",
  "lint:fix": "eslint . --fix",
  "format": "prettier --write .",
  "format:check": "prettier --check .",
  "quality": "npm run lint && npm run format:check && npm test"
}
```

---

## ‚ÑπÔ∏è Observa√ß√µes & Limita√ß√µes
- O parser aceita **`unit-cost`** (oficial) e **`unitCost`** (qualidade de vida). Se desejar, pode-se ativar um **modo estrito** aceitando **apenas** `unit-cost`.
- A aplica√ß√£o tamb√©m lida com **m√∫ltiplos arrays colados** na mesma linha (ex.: `][`). Isso n√£o √© obrigat√≥rio, mas melhora a robustez do CLI.
- **Valida√ß√£o de estoque**: A aplica√ß√£o valida que n√£o √© poss√≠vel vender mais a√ß√µes do que se possui, retornando erro apropriado.
- **Limite de erros**: Ap√≥s 3 erros consecutivos de estoque insuficiente, a conta √© bloqueada automaticamente.
- **Sistema de erros robusto**: Implementa√ß√£o de classes de erro customizadas para melhor rastreabilidade e tratamento.

---

